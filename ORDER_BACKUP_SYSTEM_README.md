# üõ°Ô∏è Sistema de Backup de Pedidos - CardaPay

## üìã Vis√£o Geral

O Sistema de Backup de Pedidos √© uma solu√ß√£o robusta que garante que todos os pedidos sejam preservados mesmo em caso de falhas durante o processo de checkout. Ele salva automaticamente os dados dos pedidos em **dois locais**:

1. **Local Storage** (navegador do cliente)
2. **Firebase** (cole√ß√£o `backup_orders`)

## üéØ Objetivos

- **Recupera√ß√£o de Pedidos**: Garantir que nenhum pedido seja perdido
- **Suporte ao Cliente**: Permitir que a equipe ajude clientes com problemas
- **Auditoria**: Rastrear todo o processo de pedido
- **Resili√™ncia**: Sistema que funciona mesmo com falhas de rede ou servidor

## üîÑ Como Funciona

### 1. **Antes do Checkout**

```typescript
// Gerar ID √∫nico para o pedido
const orderId = uuidv4();

// Criar backup antes de prosseguir
const backupSuccess = await createBackupOrder(
  orderId,
  "pending",
  restaurantId,
  user?.uid,
  cartItems,
  cartTotal,
  isDelivery,
  deliveryAddress
);
```

### 2. **Durante o Checkout**

- O `backupOrderId` √© enviado para a API de checkout
- Inclu√≠do nos metadados do Stripe
- Preservado durante todo o processo de pagamento

### 3. **Ap√≥s o Pagamento**

- **Sucesso**: Backup atualizado para status "completed"
- **Falha**: Backup atualizado para status "failed" com detalhes do erro

## üèóÔ∏è Arquitetura

### **Hook: `useOrderBackup`**

```typescript
export const useOrderBackup = () => {
  // Fun√ß√µes principais
  const createBackupOrder = async (...);
  const updateOrderStatus = async (...);
  const markOrderCompleted = async (...);
  const markOrderFailed = async (...);

  // Fun√ß√µes de recupera√ß√£o
  const getBackupOrders = async (...);
  const getFailedOrders = async (...);
  const exportBackupOrders = async (...);

  return { ... };
};
```

### **Interface: `BackupOrder`**

```typescript
export interface BackupOrder {
  id: string; // ID √∫nico do pedido
  sessionId?: string; // ID da sess√£o Stripe
  restaurantId: string; // ID do restaurante
  clientId?: string; // ID do cliente (se logado)
  items: any[]; // Itens do pedido
  totalAmount: number; // Valor total
  status: "pending" | "processing" | "completed" | "failed" | "backup";
  createdAt: Date; // Data de cria√ß√£o
  isDelivery: boolean; // Se √© entrega
  deliveryAddress?: string; // Endere√ßo de entrega
  confirmationCode?: string; // C√≥digo de confirma√ß√£o
  metadata?: {
    // Metadados adicionais
    stripeSessionId?: string;
    paymentIntentId?: string;
    error?: string;
    backupReason?: string;
  };
}
```

## üìÅ Estrutura de Arquivos

```
lib/
‚îú‚îÄ‚îÄ hooks/
‚îÇ   ‚îî‚îÄ‚îÄ useOrderBackup.ts          # Hook principal do sistema
‚îú‚îÄ‚îÄ context/
‚îÇ   ‚îî‚îÄ‚îÄ CartContext.tsx            # Contexto do carrinho (modificado)
‚îî‚îÄ‚îÄ firebase.ts                     # Configura√ß√£o do Firebase

app/
‚îú‚îÄ‚îÄ components/
‚îÇ   ‚îú‚îÄ‚îÄ restaurantSlug/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ CartSidebar.tsx        # Sidebar do carrinho (modificado)
‚îÇ   ‚îî‚îÄ‚îÄ shared/
‚îÇ       ‚îî‚îÄ‚îÄ BackupOrdersManager.tsx # Gerenciador de pedidos de backup
‚îú‚îÄ‚îÄ api/
‚îÇ   ‚îú‚îÄ‚îÄ checkout-session/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ route.ts               # API de checkout (modificada)
‚îÇ   ‚îî‚îÄ‚îÄ stripe-webhook/
‚îÇ       ‚îî‚îÄ‚îÄ route.ts               # Webhook Stripe (modificado)
‚îî‚îÄ‚îÄ (dashboard)/
    ‚îî‚îÄ‚îÄ dashboard/
        ‚îî‚îÄ‚îÄ backup-orders/
            ‚îî‚îÄ‚îÄ page.tsx            # P√°gina de pedidos de backup
```

## üöÄ Implementa√ß√£o

### **1. Integra√ß√£o no Carrinho**

```typescript
// CartSidebar.tsx
const handleCheckout = async () => {
  // 1. Gerar ID √∫nico
  const orderId = uuidv4();

  // 2. Criar backup
  const backupSuccess = await createBackupOrder(
    orderId,
    "pending",
    restaurantId,
    user?.uid,
    cartItems,
    cartTotal,
    isDelivery,
    deliveryAddress
  );

  // 3. Continuar com checkout
  const response = await fetch("/api/checkout-session", {
    body: JSON.stringify({
      // ... outros dados
      backupOrderId: orderId, // Incluir ID do backup
    }),
  });
};
```

### **2. API de Checkout**

```typescript
// checkout-session/route.ts
export async function POST(req: NextRequest) {
  const { backupOrderId, ...otherData } = await req.json();

  // Incluir no metadata do Stripe
  const metadata = {
    // ... outros metadados
    backupOrderId: backupOrderId, // Para o webhook
  };

  // Criar sess√£o Stripe
  const session = await stripe.checkout.sessions.create({
    metadata,
    // ... outras configura√ß√µes
  });
}
```

### **3. Webhook Stripe**

```typescript
// stripe-webhook/route.ts
async function handleOrderPayment(session: Stripe.Checkout.Session) {
  try {
    // ... processar pedido

    // Atualizar backup para "completed"
    if (metadata.backupOrderId) {
      await adminDb
        .collection("backup_orders")
        .doc(metadata.backupOrderId)
        .update({
          status: "completed",
          sessionId: session.id,
          // ... outros dados
        });
    }
  } catch (error) {
    // Atualizar backup para "failed"
    if (metadata.backupOrderId) {
      await adminDb
        .collection("backup_orders")
        .doc(metadata.backupOrderId)
        .update({
          status: "failed",
          error: error.message,
          // ... outros dados
        });
    }
    throw error;
  }
}
```

## üé® Interface do Usu√°rio

### **Componente: `BackupOrdersManager`**

- **Visualiza√ß√£o**: Lista todos os pedidos de backup
- **Filtros**: Por status, restaurante, cliente
- **Busca**: Por ID, cliente ou itens
- **A√ß√µes**: Ver detalhes, exportar, limpar antigos

### **Funcionalidades**

- ‚úÖ **Status em Tempo Real**: Atualiza√ß√£o autom√°tica de status
- üîç **Busca Avan√ßada**: Filtros m√∫ltiplos
- üìä **Visualiza√ß√£o Detalhada**: Modal com informa√ß√µes completas
- üì• **Exporta√ß√£o**: JSON para an√°lise externa
- üßπ **Limpeza Autom√°tica**: Remove backups antigos (>30 dias)

## üîß Configura√ß√£o

### **1. Firebase**

```typescript
// Cole√ß√£o: backup_orders
// √çndices recomendados:
// - restaurantId (ascending)
// - status (ascending)
// - createdAt (descending)
// - clientId (ascending)
```

### **2. Vari√°veis de Ambiente**

```bash
# J√° configuradas no projeto
NEXT_PUBLIC_FIREBASE_API_KEY=...
FIREBASE_ADMIN_PROJECT_ID=...
```

### **3. Depend√™ncias**

```json
{
  "uuid": "^9.0.0",
  "react-hot-toast": "^2.4.1",
  "framer-motion": "^10.16.4"
}
```

## üìä Status dos Pedidos

| Status       | Descri√ß√£o             | Cor         | A√ß√£o       |
| ------------ | --------------------- | ----------- | ---------- |
| `pending`    | Aguardando pagamento  | üü° Amarelo  | Monitorar  |
| `processing` | Processando pagamento | üîµ Azul     | Aguardar   |
| `completed`  | Pagamento confirmado  | üü¢ Verde    | Finalizado |
| `failed`     | Falha no pagamento    | üî¥ Vermelho | Investigar |
| `backup`     | Backup criado         | ‚ö™ Cinza    | Verificar  |

## üö® Cen√°rios de Falha

### **1. Falha na Cria√ß√£o do Backup**

```typescript
if (!backupSuccess) {
  console.warn("‚ö†Ô∏è Order backup failed, but continuing with checkout");
  toast.warning("‚ö†Ô∏è Backup do pedido falhou, mas continuando...");
  // Continua com checkout mesmo sem backup
}
```

### **2. Falha no Webhook**

```typescript
try {
  // Processar pedido
} catch (error) {
  // Atualizar backup para "failed"
  if (metadata.backupOrderId) {
    await updateBackupStatus(metadata.backupOrderId, "failed", error);
  }
  // Re-lan√ßar erro para retry do Stripe
  throw error;
}
```

### **3. Falha na API de Checkout**

```typescript
try {
  const response = await fetch("/api/checkout-session", {...});
  if (!response.ok) {
    throw new Error("Falha ao criar sess√£o de checkout");
  }
} catch (error) {
  // Backup j√° foi criado, pode ser recuperado
  console.error("Checkout failed, but backup exists:", error);
}
```

## üõ†Ô∏è Manuten√ß√£o

### **Limpeza Autom√°tica**

```typescript
// Remove backups com mais de 30 dias
const cleanupOldBackups = () => {
  const thirtyDaysAgo = new Date();
  thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);

  const filteredOrders = orders.filter(
    (order) => new Date(order.createdAt) > thirtyDaysAgo
  );
};
```

### **Exporta√ß√£o para Suporte**

```typescript
const exportBackupOrders = () => {
  const orders = getBackupOrders();
  const dataStr = JSON.stringify(orders, null, 2);
  const dataBlob = new Blob([dataStr], { type: "application/json" });

  const url = URL.createObjectURL(dataBlob);
  const link = document.createElement("a");
  link.href = url;
  link.download = `cardapay-backup-orders-${
    new Date().toISOString().split("T")[0]
  }.json`;
  link.click();
};
```

## üìà M√©tricas e Monitoramento

### **Logs Importantes**

```typescript
// ‚úÖ Sucesso
console.log(`‚úÖ Order ${orderId} fully backed up`);
console.log(`‚úÖ Backup order ${backupOrderId} updated to completed`);

// ‚ö†Ô∏è Avisos
console.warn("‚ö†Ô∏è Order backup failed, but continuing with checkout");
console.warn("‚ö†Ô∏è Failed to update backup order, but main order succeeded");

// ‚ùå Erros
console.error("‚ùå Failed to backup order:", error);
console.error("‚ùå Error creating order:", error);
```

### **Indicadores de Sa√∫de**

- **Taxa de Backup**: % de pedidos com backup criado
- **Taxa de Falha**: % de backups que falharam
- **Tempo de Recupera√ß√£o**: Tempo para resolver problemas
- **Pedidos √ìrf√£os**: Pedidos sem backup correspondente

## üîí Seguran√ßa

### **1. Autentica√ß√£o**

- Backup orders s√≥ acess√≠veis por usu√°rios autenticados
- Filtro por `restaurantId` para isolamento
- Valida√ß√£o de permiss√µes no backend

### **2. Dados Sens√≠veis**

- **N√ÉO** armazenar dados de cart√£o
- **N√ÉO** armazenar senhas
- **SIM** armazenar metadados de pagamento (IDs do Stripe)

### **3. Privacidade**

- Dados do cliente limitados ao necess√°rio
- Limpeza autom√°tica de dados antigos
- Exporta√ß√£o controlada para suporte

## üöÄ Pr√≥ximos Passos

### **Melhorias Futuras**

1. **Notifica√ß√µes**: Alertas para pedidos falhados
2. **Retry Autom√°tico**: Tentativas autom√°ticas de recupera√ß√£o
3. **Dashboard Avan√ßado**: M√©tricas e an√°lises
4. **Integra√ß√£o com Suporte**: Sistema de tickets
5. **Backup em Nuvem**: Sincroniza√ß√£o com servi√ßos externos

### **Monitoramento**

1. **Alertas**: Falhas cr√≠ticas no sistema
2. **M√©tricas**: Dashboard de performance
3. **Logs**: Centraliza√ß√£o e an√°lise
4. **Health Checks**: Verifica√ß√µes autom√°ticas

## üìû Suporte

### **Como Usar**

1. Acesse `/dashboard/backup-orders`
2. Visualize todos os pedidos de backup
3. Filtre por status ou busque por termo
4. Exporte dados para an√°lise
5. Gerencie pedidos falhados

### **Solu√ß√£o de Problemas**

1. **Pedido n√£o aparece**: Verificar filtros e busca
2. **Status n√£o atualiza**: Verificar logs do webhook
3. **Exporta√ß√£o falha**: Verificar permiss√µes do navegador
4. **Limpeza n√£o funciona**: Verificar data de cria√ß√£o

---

## üéâ Conclus√£o

O Sistema de Backup de Pedidos garante que **nenhum pedido seja perdido**, mesmo em cen√°rios de falha. Ele fornece:

- ‚úÖ **Resili√™ncia**: Sistema que funciona mesmo com problemas
- üîç **Rastreabilidade**: Hist√≥rico completo de todos os pedidos
- üõ†Ô∏è **Suporte**: Ferramentas para ajudar clientes
- üìä **Visibilidade**: Dashboard completo para monitoramento

Este sistema √© essencial para manter a confian√ßa dos clientes e a opera√ß√£o do restaurante, mesmo em situa√ß√µes adversas.
